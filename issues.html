<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نَسَق – CAPA &amp; الملاحظات</title>

  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ن</div>
      <div>
        <div style="font-weight:900;font-size:18px">غرفة عمليات نَسَق</div>
        <div class="muted">Pilot: طوبى • سدف • دبل بي</div>
      </div>
    </div>
    <div class="badge">MVP محلي</div>
  </div>

  <div class="container">
    <div class="nav">
      <a data-nav href="index.html">لوحة التحكم</a>
      <a data-nav href="visits.html">الزيارات</a>
      <a data-nav href="issues.html">CAPA &amp; الملاحظات</a>
      <a data-nav href="tasks.html">المهام</a>
      <a data-nav href="cleaning.html">النظافة اليومية</a>
      <a data-nav href="sop.html">مكتبة SOP</a>
      <a data-nav href="settings.html">الإعدادات</a>
    </div>

    <div class="grid">
      <!-- Editor -->
      <div class="card" style="grid-column: span 5">
        <h3>تحديث ملاحظة</h3>
        <div class="muted" id="editHint">اختر ملاحظة من الجدول للتحديث، أو افتحها من صفحة النظافة.</div>

        <label class="small muted" style="margin-top:10px;display:block">رقم CAPA</label>
        <input id="eId" class="input" placeholder="CAPA-XXXX" disabled>

        <label class="small muted" style="margin-top:10px;display:block">المسؤول</label>
        <input id="eOwner" class="input" placeholder="مثال: مدير الفرع">

        <label class="small muted" style="margin-top:10px;display:block">الحالة</label>
        <select id="eStatus" class="input">
          <option>مفتوح</option>
          <option>قيد التنفيذ</option>
          <option>متأخر</option>
          <option>مغلق</option>
        </select>

        <label class="small muted" style="margin-top:10px;display:block">الاستحقاق</label>
        <input id="eDue" class="input" type="date">

        <label class="small muted" style="margin-top:10px;display:block">إثبات / ملاحظة الإغلاق</label>
        <textarea id="eEvidence" class="input" placeholder="مثال: تم التنظيف وإرفاق صورة في الزيارة القادمة..."></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="saveEdit">حفظ التحديث</button>
          <button class="btn secondary" id="clearEdit">زيارة جديدة</button>
        </div>
      </div>

      <!-- Table -->
      <div class="card" style="grid-column: span 7">
        <h3>CAPA &amp; الملاحظات</h3>
        <div class="muted" style="margin-bottom:10px">
          تابع الملاحظات، حدّد المسؤول، أغلق مع إثبات. (حاليًا محليًا – LocalStorage)
        </div>

        <div class="row" style="margin-bottom:10px">
          <select id="fStatus" class="input" style="max-width:220px">
            <option value="">كل الحالات</option>
            <option>مفتوح</option><option>قيد التنفيذ</option><option>متأخر</option><option>مغلق</option>
          </select>
          <input id="fSearch" class="input" placeholder="بحث (CAPA/ملاحظة/مسؤول/براند/فرع)">
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>الحالة</th>
              <th>الخطورة</th>
              <th>البراند</th>
              <th>الفرع</th>
              <th>الملاحظة</th>
              <th>الاستحقاق</th>
              <th>المسؤول</th>
            </tr>
          </thead>
          <tbody id="issueTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      تلميح: من صفحة النظافة، أي “جزئي/لم يتم” سينشئ CAPA تلقائيًا ويمكن فتحه مباشرة.
    </div>
  </div>

<script>
const DB_KEY = "naseq_ops_db_v1";
const nowISO = () => new Date().toISOString();

function seedDB(){
  const db = {
    meta: { createdAt: nowISO(), language: "ar", pilot: true },
    brands: [
      { id: "tuba", name: "طوبى", branches:[{id:"tuba-main", name:"طوبى – الفرع الرئيسي"}]},
      { id: "sdf",  name: "سدف",  branches:[{id:"sdf-main",  name:"سدف – الفرع الرئيسي"}]},
      { id: "dbb",  name: "دبل بي", branches:[{id:"dbb-main", name:"دبل بي – الفرع الرئيسي"}]},
    ],
    cleaningLogs: [],
    issues: [],
    tasks: [],
    visits: [],
    sops: []
  };
  localStorage.setItem(DB_KEY, JSON.stringify(db));
  return db;
}

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return seedDB();
  try { return JSON.parse(raw); } catch(e){ return seedDB(); }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

function $id(id){ return document.getElementById(id); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

function setActiveNav(){
  const path = location.pathname.split("/").pop() || "index.html";
  $all("[data-nav]").forEach(a => {
    if(a.getAttribute("href") === path) a.classList.add("active");
  });
}

function statusPill(status){
  if(status === "مغلق") return `<span class="pill ok">مغلق</span>`;
  if(status === "متأخر") return `<span class="pill warn">متأخر</span>`;
  if(status === "قيد التنفيذ") return `<span class="pill warn">قيد التنفيذ</span>`;
  return `<span class="pill danger">مفتوح</span>`;
}

function severityPill(sev){
  if(sev === "عالي") return `<span class="pill danger">عالي</span>`;
  if(sev === "متوسط") return `<span class="pill warn">متوسط</span>`;
  return `<span class="pill ok">منخفض</span>`;
}

function brandNameById(id){
  const db = loadDB();
  return db.brands.find(b=>b.id===id)?.name || id || "—";
}
function branchNameById(brandId, branchId){
  const db = loadDB();
  const b = db.brands.find(x=>x.id===brandId);
  return b?.branches?.find(br=>br.id===branchId)?.name || branchId || "—";
}

let currentEditId = null;

function renderIssues(){
  const db = loadDB();
  const tbody = $id("issueTbody");

  const fs = $id("fStatus").value;
  const q  = ($id("fSearch").value || "").toLowerCase();

  const rows = db.issues.filter(i => {
    const okStatus = (!fs || i.status === fs);
    const blob = JSON.stringify({
      id:i.id, status:i.status, severity:i.severity,
      brand: brandNameById(i.brandId),
      branch: branchNameById(i.brandId, i.branchId),
      title:i.title, note:i.note, owner:i.owner, dueDate:i.dueDate
    }).toLowerCase();
    const okQ = (!q || blob.includes(q));
    return okStatus && okQ;
  });

  tbody.innerHTML = rows.slice().reverse().map(i => `
    <tr data-id="${i.id}" style="cursor:pointer">
      <td>${statusPill(i.status)}</td>
      <td>${severityPill(i.severity || "متوسط")}</td>
      <td>${brandNameById(i.brandId)}</td>
      <td>${branchNameById(i.brandId, i.branchId)}</td>
      <td>
        <div style="font-weight:700">${i.id} — ${i.title || "—"}</div>
        <div class="muted small">${i.note || "—"}</div>
      </td>
      <td class="muted">${i.dueDate || "—"}</td>
      <td class="muted">${i.owner || "—"}</td>
    </tr>
  `).join("") || `<tr><td colspan="7" class="muted">لا توجد ملاحظات حتى الآن.</td></tr>`;

  // click handler to edit
  $all("tr[data-id]").forEach(tr => {
    tr.addEventListener("click", () => openEdit(tr.getAttribute("data-id")));
  });
}

function openEdit(id){
  const db = loadDB();
  const item = db.issues.find(x => x.id === id);
  if(!item) return;

  currentEditId = id;
  $id("editHint").textContent = `تحديث ${id} (المصدر: ${item.source || "—"})`;
  $id("eId").value = item.id;
  $id("eOwner").value = item.owner || "";
  $id("eStatus").value = item.status || "مفتوح";
  $id("eDue").value = item.dueDate || "";
  $id("eEvidence").value = item.evidence || "";
  // scroll to editor on mobile
  window.scrollTo({ top: 0, behavior:"smooth" });
}

function clearEdit(){
  currentEditId = null;
  $id("editHint").textContent = "اختر ملاحظة من الجدول للتحديث، أو افتحها من صفحة النظافة.";
  $id("eId").value = "";
  $id("eOwner").value = "";
  $id("eStatus").value = "مفتوح";
  $id("eDue").value = "";
  $id("eEvidence").value = "";
}

function saveEdit(){
  if(!currentEditId) return alert("اختر CAPA أولًا من الجدول.");
  const db = loadDB();
  const idx = db.issues.findIndex(x => x.id === currentEditId);
  if(idx < 0) return alert("CAPA غير موجود.");

  db.issues[idx].owner = ($id("eOwner").value || "").trim();
  db.issues[idx].status = $id("eStatus").value;
  db.issues[idx].dueDate = $id("eDue").value;
  db.issues[idx].evidence = ($id("eEvidence").value || "").trim();
  db.issues[idx].updatedAt = nowISO();

  saveDB(db);
  renderIssues();
  alert("تم حفظ التحديث ✅");
}

function getQueryParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

/* Init */
(function init(){
  setActiveNav();
  renderIssues();

  $id("fStatus").addEventListener("change", renderIssues);
  $id("fSearch").addEventListener("input", renderIssues);

  $id("saveEdit").addEventListener("click", saveEdit);
  $id("clearEdit").addEventListener("click", clearEdit);

  // Deep link from cleaning: issues.html?edit=CAPA-XXXX
  const editId = getQueryParam("edit");
  if(editId){
    // render first then open
    openEdit(editId);
  }
})();
</script>
</body>
</html>
