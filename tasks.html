<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نَسَق – المهام</title>

  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&display=swap" rel="stylesheet">

  <style>
    body{font-family:"Almarai",sans-serif}
    .cardx{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:0 12px 26px rgba(0,0,0,.08);padding:16px}
    .muted{color:#6b7280}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media(max-width:950px){.grid2{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.14);font-family:inherit}
    textarea{min-height:90px;resize:vertical}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:none;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--nasaq-primary,#b91c1c);color:#fff}
    .btn-outline{background:#fff;border:1px solid rgba(0,0,0,.14);color:#111827}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px;text-align:right;font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-weight:900;font-size:12px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot-green{background:#22c55e}
    .dot-orange{background:#f59e0b}

    /* ===== Unified Top Nav ===== */
    .nasaq-topnav{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:14px; margin:14px auto;
      border-radius:18px; background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }
    .nasaq-topnav .tab{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff; color:#111827; font-weight:900;
      text-decoration:none; transition:.15s ease;
    }
    .nasaq-topnav .tab:hover{transform:translateY(-1px)}
    .nasaq-topnav .tab-active{
      background: var(--nasaq-primary, #b91c1c);
      color:#fff;
      border-color: var(--nasaq-primary, #b91c1c);
    }
  </style>
</head>

<body>
<main class="container">

  <!-- NAV الموحد -->
  <div class="nasaq-topnav" id="topnav">
    <a href="index.html" class="tab" data-page="index.html">الرئيسية</a>
    <a href="visits.html" class="tab" data-page="visits.html">الزيارات</a>
    <a href="tasks.html" class="tab" data-page="tasks.html">المهام</a>
    <a href="cleaning.html" class="tab" data-page="cleaning.html">النظافة</a>
    <a href="sop.html" class="tab" data-page="sop.html">SOP</a>
    <a href="settings.html" class="tab" data-page="settings.html">الإعدادات</a>
    <a href="plans.html" class="tab" data-page="plans.html">الخطط</a>
  </div>

  <div class="cardx">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
      <div>
        <h1 style="margin:0;font-weight:900">المهام – MVP</h1>
        <div class="muted">إنشاء مهام بسيطة وحفظها محليًا (LocalStorage).</div>
      </div>
      <span class="pill"><span class="dot dot-green"></span> حفظ محلي</span>
    </div>
  </div>

  <div class="grid2" style="margin-top:14px">

    <div class="cardx">
      <h2 style="margin:0 0 10px;font-weight:900">إنشاء مهمة</h2>

      <div class="row">
        <div>
          <label class="muted">البراند</label>
          <select id="brand">
            <option value="سدف">سدف</option>
            <option value="طوبى">طوبى</option>
            <option value="دبل بي">دبل بي</option>
            <option value="Flavor Town">Flavor Town</option>
          </select>
        </div>
        <div>
          <label class="muted">القسم</label>
          <select id="dept">
            <option value="التشغيل">التشغيل</option>
            <option value="الإدارة">الإدارة</option>
            <option value="الصيانة">الصيانة</option>
            <option value="المالية">المالية</option>
            <option value="المطبخ">المطبخ</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label class="muted">الموعد</label>
          <input id="due" type="date">
        </div>
        <div>
          <label class="muted">الحالة</label>
          <select id="status">
            <option value="غير منجز" selected>غير منجز</option>
            <option value="منجز">منجز</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="muted">عنوان المهمة</label>
        <input id="title" placeholder="مثال: توثيق مكافحة الحشرات">
      </div>

      <div style="margin-top:10px">
        <label class="muted">ملاحظات</label>
        <textarea id="notes" placeholder="تفاصيل التنفيذ/الإثبات..."></textarea>
      </div>

      <div class="btnrow">
        <button class="btn btn-primary" onclick="addTask()">حفظ المهمة</button>
        <button class="btn btn-outline" onclick="resetForm()">مسح الحقول</button>
      </div>
    </div>

    <div class="cardx">
      <h2 style="margin:0 0 10px;font-weight:900">فلاتر سريعة</h2>
      <div class="row">
        <select id="fBrand" onchange="render()">
          <option value="الكل" selected>كل البراندات</option>
          <option value="سدف">سدف</option>
          <option value="طوبى">طوبى</option>
          <option value="دبل بي">دبل بي</option>
          <option value="Flavor Town">Flavor Town</option>
        </select>
        <select id="fStatus" onchange="render()">
          <option value="الكل" selected>كل الحالات</option>
          <option value="غير منجز">غير منجز</option>
          <option value="منجز">منجز</option>
        </select>
      </div>

      <div class="btnrow" style="margin-top:12px">
        <button class="btn btn-outline" onclick="exportJSON()">تصدير JSON</button>
        <label class="btn btn-outline" style="cursor:pointer">
          استيراد JSON
          <input type="file" accept="application/json" style="display:none" onchange="importJSON(event)">
        </label>
        <button class="btn btn-outline" onclick="clearAll()">حذف كل المهام</button>
      </div>

      <div class="pill" style="margin-top:12px">
        <span class="dot dot-orange"></span>
        تنبيه: البيانات محلية على هذا المتصفح فقط.
      </div>
    </div>

  </div>

  <div class="cardx" style="margin-top:14px">
    <h2 style="margin:0 0 10px;font-weight:900">سجل المهام</h2>
    <table class="table">
      <thead>
        <tr>
          <th>الموعد</th>
          <th>البراند</th>
          <th>القسم</th>
          <th>العنوان</th>
          <th>الحالة</th>
          <th>ملاحظات</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" class="muted">لا توجد مهام بعد.</td></tr>
      </tbody>
    </table>
  </div>

</main>

<script>
  // ===== Active tab تلقائي =====
  (function activateTab(){
    const file = (location.pathname.split("/").pop() || "index.html").toLowerCase();
    document.querySelectorAll("#topnav .tab").forEach(a=>{
      const p = (a.getAttribute("data-page")||"").toLowerCase();
      if(p === file) a.classList.add("tab-active");
    });
  })();

  const LS_KEY="tasks_v1";

  function todayISO(){
    const d=new Date();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const day=String(d.getDate()).padStart(2,"0");
    return `${d.getFullYear()}-${m}-${day}`;
  }
  document.getElementById("due").value = todayISO();

  function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||"[]")}catch(e){return []} }
  function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

  function resetForm(){
    document.getElementById("title").value="";
    document.getElementById("notes").value="";
    document.getElementById("status").value="غير منجز";
    document.getElementById("due").value=todayISO();
  }

  function addTask(){
    const title=(document.getElementById("title").value||"").trim();
    if(!title){ alert("اكتب عنوان المهمة"); return; }
    const t={
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      due: document.getElementById("due").value || todayISO(),
      brand: document.getElementById("brand").value,
      dept: document.getElementById("dept").value,
      title,
      status: document.getElementById("status").value,
      notes: (document.getElementById("notes").value||"").trim()
    };
    const arr=load(); arr.push(t); save(arr);
    render(); resetForm();
    alert("تم حفظ المهمة ✅");
  }

  function toggleStatus(id){
    const arr=load();
    const item=arr.find(x=>x.id===id);
    if(!item) return;
    item.status = (item.status==="منجز") ? "غير منجز" : "منجز";
    save(arr); render();
  }

  function removeTask(id){
    save(load().filter(x=>x.id!==id));
    render();
  }

  function render(){
    const fBrand=document.getElementById("fBrand").value;
    const fStatus=document.getElementById("fStatus").value;

    let arr=load().sort((a,b)=> (a.due||"").localeCompare(b.due||""));
    arr=arr.filter(x=>{
      const okB=(fBrand==="الكل") || x.brand===fBrand;
      const okS=(fStatus==="الكل") || x.status===fStatus;
      return okB && okS;
    });

    const rows=document.getElementById("rows");
    if(!arr.length){
      rows.innerHTML=`<tr><td colspan="7" class="muted">لا توجد مهام بعد.</td></tr>`;
      return;
    }

    rows.innerHTML=arr.map(x=>`
      <tr>
        <td>${x.due||""}</td>
        <td>${x.brand||""}</td>
        <td>${x.dept||""}</td>
        <td><b>${x.title.replace(/</g,"&lt;")}</b></td>
        <td>
          <button class="btn btn-outline" onclick="toggleStatus('${x.id}')">${x.status}</button>
        </td>
        <td>${(x.notes||"").replace(/</g,"&lt;")}</td>
        <td><button class="btn btn-outline" onclick="removeTask('${x.id}')">حذف</button></td>
      </tr>
    `).join("");
  }

  function exportJSON(){
    const data=load();
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="nasaq-tasks.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJSON(ev){
    const file=ev.target.files && ev.target.files[0];
    if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result);
        if(!Array.isArray(arr)) throw 0;
        save(arr); render(); alert("تم الاستيراد ✅");
      }catch(e){ alert("ملف JSON غير صالح"); }
      finally{ ev.target.value=""; }
    };
    r.readAsText(file);
  }

  function clearAll(){
    if(!confirm("حذف كل المهام؟")) return;
    localStorage.removeItem(LS_KEY);
    render();
  }

  render();
</script>

</body>
</html>
