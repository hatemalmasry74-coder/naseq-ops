<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نسق – الإعدادات</title>

  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ن</div>
      <div>
        <div style="font-weight:900">غرفة عمليات نَسَق</div>
        <div class="muted">Pilot: طوبى • سدف • دبل بي — (عربي/RTL)</div>
      </div>
    </div>
    <div class="badge">MVP محلي (Prototype)</div>
  </div>

  <div class="container">
    <div class="nav">
      <a data-nav href="index.html">لوحة التحكم</a>
      <a data-nav href="visits.html">الزيارات</a>
      <a data-nav href="issues.html">CAPA & الملاحظات</a>
      <a data-nav href="tasks.html">المهام</a>
      <a data-nav href="cleaning.html">النظافة اليومية</a>
      <a data-nav href="sop.html">مكتبة SOP</a>
      <a data-nav href="settings.html">الإعدادات</a>
    </div>

    <div class="grid">
      <div class="card" style="grid-column:span 5">
        <h3>إعداد اللغة</h3>
        <div class="muted">حالياً: عربي. (الإنجليزي لاحقاً)</div>

        <label class="small">اللغة الحالية</label>
        <select class="input" disabled>
          <option>العربية</option>
        </select>

        <div class="muted" style="margin-top:10px">
          ملاحظة: عند تحويله إلى نسخة مستضافة + قاعدة بيانات سنفعّل التعدد اللغوي بالكامل.
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:16px 0">

        <h3>تصدير / استيراد</h3>
        <div class="row">
          <button class="btn primary" id="exportBtn">تصدير JSON</button>
          <label class="btn ghost" style="cursor:pointer">
            استيراد JSON
            <input id="importFile" type="file" accept="application/json" style="display:none">
          </label>
        </div>
      </div>

      <div class="card" style="grid-column:span 7">
        <h3>إعدادات البراندات والفروع</h3>
        <div class="muted">Pilot: لكل براند فرع واحد. يمكنك إضافة فروع لاحقًا.</div>

        <label class="small">اختر البراند</label>
        <select id="sBrand" class="input"></select>

        <label class="small">اسم الفرع الجديد</label>
        <input id="newBranchName" class="input" placeholder="مثال: طوبى – فرع الجامعة">

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="addBranchBtn">إضافة فرع</button>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:16px 0">

        <h3>الفروع الحالية</h3>
        <div id="branchList" class="muted"></div>
      </div>
    </div>

    <div class="footer">
      هذا نموذج أولي محلي (LocalStorage). للاستخدام الفعلي نحتاج استضافة + قاعدة بيانات + صلاحيات.
    </div>
  </div>

<script>
const DB_KEY="naseq_ops_db_v1";
const nowISO=()=>new Date().toISOString();

function seedDB(){
  const db={
    meta:{createdAt:nowISO(),lang:"ar"},
    brands:[
      { id:"tuba", name:"طوبى", branches:[{id:"tuba-main", name:"طوبى – الفرع الرئيسي"}] },
      { id:"sdf",  name:"سدف",  branches:[{id:"sdf-main",  name:"سدف – الفرع الرئيسي"}] },
      { id:"dbb",  name:"دبل بي",branches:[{id:"dbb-main",  name:"دبل بي – الفرع الرئيسي"}] }
    ],
    visits:[],
    tasks:[],
    issues:[],
    cleaningLogs:[],
    sops:[]
  };
  localStorage.setItem(DB_KEY, JSON.stringify(db));
  return db;
}
function loadDB(){
  const raw=localStorage.getItem(DB_KEY);
  if(!raw) return seedDB();
  try{ return JSON.parse(raw); }catch(e){ return seedDB(); }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

function setActiveNav(){
  const path = location.pathname.split("/").pop() || "index.html";
  document.querySelectorAll("[data-nav]").forEach(a=>{
    if(a.getAttribute("href")===path) a.classList.add("active");
  });
}
function newId(prefix){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function renderBrands(){
  const db=loadDB();
  const sBrand=document.getElementById("sBrand");
  sBrand.innerHTML=db.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  renderBranchList();
}
function renderBranchList(){
  const db=loadDB();
  const sBrand=document.getElementById("sBrand");
  const list=document.getElementById("branchList");
  const b=db.brands.find(x=>x.id===sBrand.value);
  if(!b){ list.textContent=""; return; }
  list.innerHTML = (b.branches||[]).map(br=>`• ${br.name}`).join("<br>") || "لا توجد فروع.";
}

document.getElementById("sBrand").addEventListener("change", renderBranchList);

document.getElementById("addBranchBtn").addEventListener("click", ()=>{
  const name=(document.getElementById("newBranchName").value||"").trim();
  if(!name){
    alert("اكتب اسم الفرع");
    return;
  }
  const db=loadDB();
  const sBrand=document.getElementById("sBrand");
  const b=db.brands.find(x=>x.id===sBrand.value);
  if(!b) return;

  b.branches = b.branches || [];
  b.branches.push({ id:newId("branch"), name });
  saveDB(db);

  document.getElementById("newBranchName").value="";
  alert("تمت الإضافة ✅");
  renderBranchList();
});

/* Export / Import */
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const db=loadDB();
  const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="naseq_ops_export.json";
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById("importFile").addEventListener("change", (e)=>{
  const file=e.target.files?.[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      localStorage.setItem(DB_KEY, JSON.stringify(obj));
      alert("تم الاستيراد بنجاح ✅");
      location.reload();
    }catch(err){
      alert("ملف غير صالح");
    }
  };
  reader.readAsText(file);
});

setActiveNav();
renderBrands();
</script>
</body>
</html>
