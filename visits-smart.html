<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù†ÙØ³ÙÙ‚ â€“ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ (V1)</title>

  <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ù„Ù Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ù†ÙØ³ÙÙ‚ -->
  <link rel="stylesheet" href="nasaq-theme.css">

  <!-- Ø®Ø· -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111826;
      --muted:#98a2b3;
      --text:#e6eaf2;
      --line:rgba(255,255,255,.08);
      --primary:#b91c1c;  /* Ø£Ø­Ù…Ø± Ù†Ø³Ù‚ */
      --accent:#f4e7d3;   /* Ø¨ÙŠØ¬ Ù†Ø³Ù‚ */
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    [data-theme="light"]{
      --bg:#f7f7fb;
      --card:#ffffff;
      --muted:#667085;
      --text:#111827;
      --line:rgba(17,24,39,.10);
      --shadow: 0 10px 30px rgba(17,24,39,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Almarai", system-ui, -apple-system, Segoe UI, Arial;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(185,28,28,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(244,231,211,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 14px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px
    }
    .brand{
      display:flex;flex-direction:column;gap:4px
    }
    .brand h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: none;
      font-weight:700;
      font-size:13px;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.primary{background:linear-gradient(135deg, rgba(185,28,28,.95), rgba(185,28,28,.70)); border-color:transparent}
    .btn.ghost{background:transparent}
    .btn:active{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 420px 1fr;}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;font-weight:800}
    .card .bd{padding:14px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:grid;gap:10px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--text);
      border-radius:12px;
      outline:none;
      font-family:inherit;
      font-size:13px;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.12);
    }
    [data-theme="light"] .kpi{background:rgba(17,24,39,.03)}
    .kpi .n{font-size:26px;font-weight:900;margin:0}
    .kpi .t{margin:4px 0 0 0;font-size:12px;color:var(--muted);font-weight:800}
    .badge{
      padding:7px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid var(--line)
    }
    .b-ok{background:rgba(22,163,74,.18); border-color:rgba(22,163,74,.25)}
    .b-warn{background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.25)}
    .b-bad{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.25)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      vertical-align:top;
      font-size:13px;
    }
    th{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      background:rgba(255,255,255,.02);
      position:sticky;top:0;z-index:2;
    }
    .tbl-wrap{max-height:68vh;overflow:auto}
    .item-title{font-weight:900}
    .mini{font-size:11px;color:var(--muted);margin-top:4px}
    .file{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .thumb{
      width:42px;height:42px;border-radius:12px;border:1px solid var(--line);
      object-fit:cover;background:rgba(255,255,255,.03)
    }
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:12px;border:1px dashed var(--line);
      color:var(--muted);font-size:12px;font-weight:800
    }
    .req{color:var(--accent);font-weight:900}
    .footer-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

    /* ====== Print (ØªØµØ¯ÙŠØ± PDF Ø¹Ø¨Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) ====== */
    @media print{
      body{background:#fff;color:#111}
      .top-actions, .footer-actions, .tbl-wrap{display:none !important}
      .grid{grid-template-columns: 1fr}
      .card{box-shadow:none}
      .card .bd{padding:10px}
      .print-area{display:block !important}
      .no-print{display:none !important}
    }
    .print-area{display:none}
  </style>
</head>

<body>
<div class="wrap" id="app">
  <header>
    <div class="brand">
      <h1>Ù…Ù†ØµØ© Ù†ÙØ³ÙÙ‚ â€“ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ (V1)</h1>
      <p>ØªØ´ØºÙŠÙ„ + Ø³Ù„Ø§Ù…Ø© ØºØ°Ø§Ø¡ + Ø§Ù…ØªØ«Ø§Ù„ + CAPA â€” Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ù„Ù‚Ø±Ø§Ø±</p>
    </div>

    <div class="top-actions">
      <button class="btn ghost" id="toggleTheme">ğŸŒ™ / â˜€ï¸</button>
      <button class="btn" id="saveDraft">ğŸ’¾ Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©</button>
      <button class="btn" id="loadDraft">ğŸ“¥ Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
      <button class="btn" id="downloadJson">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ JSON</button>
      <button class="btn primary" id="printPdf">ğŸ§¾ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
  </header>

  <div class="grid">

    <!-- ===== Left: Meta + KPI ===== -->
    <section class="card">
      <div class="hd">
        <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h2>
        <span class="badge" id="decisionBadge">â€”</span>
      </div>

      <div class="bd">
        <div class="row cols-2">
          <div>
            <label>Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ <span class="req">*</span></label>
            <input id="brand" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¯Ù / Ø·ÙˆØ¨Ù‰ / Ø¯Ø¨Ù„ Ø¨ÙŠ">
          </div>
          <div>
            <label>Ø§Ù„ÙØ±Ø¹ <span class="req">*</span></label>
            <input id="branch" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨Ù‡Ø§ / Ø®Ù…ÙŠØ³ / Ø¬ÙŠØ²Ø§Ù†">
          </div>
        </div>

        <div class="row cols-2" style="margin-top:10px">
          <div>
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
            <input id="city" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨Ù‡Ø§">
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø© <span class="req">*</span></label>
            <input id="visit_date" type="date">
          </div>
        </div>

        <div class="row cols-2" style="margin-top:10px">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØºÙ‘Ù„ <span class="req">*</span></label>
            <input id="operator_name" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø§ØªÙ… / Ø£Ø­Ù…Ø¯">
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
            <select id="visit_type">
              <option value="ØªØ´ØºÙŠÙ„ÙŠØ©">ØªØ´ØºÙŠÙ„ÙŠØ©</option>
              <option value="Ø³Ù„Ø§Ù…Ø© ØºØ°Ø§Ø¡">Ø³Ù„Ø§Ù…Ø© ØºØ°Ø§Ø¡</option>
              <option value="Ù…Ø§Ù„ÙŠØ©">Ù…Ø§Ù„ÙŠØ©</option>
              <option value="ØªØ·ÙˆÙŠØ± Ù…Ù†ØªØ¬Ø§Øª">ØªØ·ÙˆÙŠØ± Ù…Ù†ØªØ¬Ø§Øª</option>
              <option value="Ø·Ø§Ø±Ø¦Ø©">Ø·Ø§Ø±Ø¦Ø©</option>
            </select>
          </div>
        </div>

        <div class="row cols-2" style="margin-top:10px">
          <div>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
            <input id="check_in_time" type="time">
          </div>
          <div>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</label>
            <input id="check_out_time" type="time">
          </div>
        </div>

        <div style="margin-top:14px" class="kpis">
          <div class="kpi">
            <p class="n" id="scoreValue">0%</p>
            <p class="t">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</p>
          </div>
          <div class="kpi">
            <p class="n" id="violationsValue">0</p>
            <p class="t">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</p>
          </div>
        </div>

        <div style="margin-top:10px" class="kpis">
          <div class="kpi">
            <p class="n" id="improveValue">0</p>
            <p class="t">Ø¨Ù†ÙˆØ¯ ØªØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</p>
          </div>
          <div class="kpi">
            <p class="n" id="openCapaValue">0</p>
            <p class="t">CAPA Ù…ÙØªÙˆØ­Ø©</p>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Ù…Ù„Ø®Øµ Ø¹Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="summary" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙØ±Ø¹â€¦"></textarea>
          <p class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØµØ¯ÙŠØ± PDF ÙŠØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Save as PDF).</p>
        </div>

        <div class="footer-actions no-print">
          <button class="btn" id="markAllCompliant">âœ… Ø¬Ø¹Ù„ Ø§Ù„ÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚</button>
          <button class="btn" id="markAllNeedsImprove">âš ï¸ Ø¬Ø¹Ù„ Ø§Ù„ÙƒÙ„ ØªØ­Ø³ÙŠÙ†</button>
          <button class="btn" id="resetAll">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        </div>
      </div>
    </section>

    <!-- ===== Right: Checklist ===== -->
    <section class="card">
      <div class="hd">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ (29 Ø¨Ù†Ø¯)</h2>
        <span class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© + Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© + Ø£Ø¶Ù CAPA Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©</span>
      </div>

      <div class="bd">
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:34%">Ø§Ù„Ø¨Ù†Ø¯</th>
                <th style="width:12%">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th style="width:12%">Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
                <th style="width:18%">ØµÙˆØ±Ø©</th>
                <th style="width:24%">Ù…Ù„Ø§Ø­Ø¸Ø© / CAPA</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- ===== Print Summary Area (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) ===== -->
  <section class="card print-area" style="margin-top:12px">
    <div class="hd"><h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø²ÙŠØ§Ø±Ø© (Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©)</h2></div>
    <div class="bd" id="printSummary"></div>
  </section>
</div>

<script>
  // ========= Items =========
  const ITEMS = [
    {id:"FS01", title:"ÙŠØ¬Ø¨ ØªÙˆÙØ± Ù…Ø¹Ù‚Ù…Ø§Øª Ø§Ù„Ø£ÙŠØ¯ÙŠ"},
    {id:"FS02", title:"Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"},
    {id:"FS03", title:"ØºØ·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯Ù… (Ø§Ù„Ø´ÙØ§Ø·) / Ø§Ù„Ù…Ø¬Ù…Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø¨Ø±Ø¯Ø§Øª"},
    {id:"FS04", title:"ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø·ÙØ§ÙŠØ© Ø§Ù„Ø­Ø±ÙŠÙ‚"},
    {id:"FS05", title:"Ø§ÙˆÙ‚Ø§Øª Ø±Ø§Ø­Ø© / ØºØ¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"},
    {id:"FS06", title:"Ø§Ù†Ø§Ø±Ø© Ø§Ù„ÙØ±Ø¹"},
    {id:"FS07", title:"Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ø±ÙÙˆÙ"},
    {id:"FS08", title:"ØªÙ†Ø¸ÙŠÙ… ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø«Ù„Ø§Ø¬Ø§Øª"},
    {id:"FS09", title:"Ø§Ù„Ù†Ø¸Ø§ÙÙ‡ Ø§Ù„Ø¹Ø§Ù…Ù‡ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø²ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ"},
    {id:"FS10", title:"ØªØ®Ø²ÙŠÙ† Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª"},
    {id:"FS11", title:"Ø§Ù…ØªÙ†Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø®Ù†ÙŠÙ† Ø¹Ù† Ø§Ù„ØªØ¯Ø®ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ø±ØªØ¯Ø§Ø¡ Ø§Ù„Ù…Ø±ÙŠÙˆÙ„ Ø§Ùˆ Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø±Ø£Ø³"},
    {id:"FS12", title:"Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ù„Ø¯ÙŠÙ‡"},
    {id:"FS13", title:"Ø§Ø³Ù„Ø§Ùƒ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§"},
    {id:"FS14", title:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡"},
    {id:"FS15", title:"Ø§Ù„Ù…Ù†Ø·Ù‚Ù‡ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠÙ‡ Ø§Ù„ÙØ±Ø¹"},
    {id:"FS16", title:"Ø§Ù„Ø­Ø´Ø±Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø±Ø¶"},
    {id:"FS17", title:"Ø§Ù„Ø§ÙƒÙ„ Ø§Ù„Ù…Ø·Ø¨ÙˆØ® ÙˆØ§Ù„ØºÙŠØ± Ù…Ø·Ø¨ÙˆØ®"},
    {id:"FS18", title:"Ù‚Ø§ØªÙ„ Ø§Ù„Ø­Ø´Ø±Ø§Øª ÙˆÙ…ØµÙŠØ¯Ø© Ø§Ù„Ø°Ø¨Ø§Ø¨ Ù…ØªÙˆÙØ± ÙˆØ¨Ø­Ø§Ù„Ù‡ Ø¬ÙŠØ¯Ø©"},
    {id:"FS19", title:"Ø¨Ù„Ø§Ø¹Ø© Ø§Ù„Ø§Ø±Ø¶ ÙˆÙ…ØºØ³Ù„Ø© Ø§Ù„Ø§Ø±Ø¶ÙŠÙ‡"},
    {id:"FS20", title:"Ø§Ù„Ø§Ø±Ø§Ø¶ÙŠ ÙˆØ§Ù„Ø§Ø³Ø·Ø­ ÙˆØ§Ù„Ø¬Ø¯Ø±Ø§Ù†"},
    {id:"FS21", title:"Ø§Ø­ÙƒØ§Ù… ÙˆØ´Ø±ÙˆØ· Ø§Ù„Ù„Ù…Ø³ Ø¹Ù†Ø¯ Ø§Ø±ØªØ¯Ø§Ø¡ Ø§Ù„Ù‚ÙØ§Ø²Ø§Øª"},
    {id:"FS22", title:"Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª"},
    {id:"FS23", title:"Ø§Ù„Ù…Ù†Ø·Ù‚Ù‡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠÙ‡ Ù„Ù„ÙØ±Ø¹"},
    {id:"FS24", title:"Ø§Ù„Ø­Ø§Ù„Ù‡ Ø§Ù„ØµØ­ÙŠÙ‡ Ù„Ù„Ø¹Ù…Ø§Ù„"},
    {id:"FS25", title:"Ø§Ù„Ø³ØªØ§Ø±Ù‡ Ø§Ù„Ù‡ÙˆØ§Ø¦ÙŠÙ‡ (Ø§Ù„Ù…Ø¯Ø§Ø®Ù„ Ø§Ù„Ø§Ù…Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©)"},
    {id:"FS26", title:"Ù…ØµÙØ§Ø© Ø§Ù„Ø²ÙŠØª ÙˆØ®Ø·ÙˆØ·Ù‡Ø§"},
    {id:"FS27", title:"Ù…Ù„ØµÙ‚Ø§Øª ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØµØ§Ø­ÙŠÙ‡"},
    {id:"FS28", title:"Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© ÙˆØ§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø®Ø§Ø±Ø¬ÙŠÙ‹Ø©"},
    {id:"FS29", title:"Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©"}
  ];

  const points = { compliant: 100, improvement: 50, violation: 0 };

  // ========= DOM =========
  const $ = (id)=>document.getElementById(id);
  const itemsBody = $("itemsBody");

  // ========= State =========
  const state = {
    meta: {
      brand:"", branch:"", city:"", visit_date:"", operator_name:"",
      visit_type:"ØªØ´ØºÙŠÙ„ÙŠØ©", check_in_time:"", check_out_time:"", summary:""
    },
    items: ITEMS.map(x => ({
      item_id: x.id,
      title: x.title,
      status: "compliant",
      risk_level: "low",
      photo: "", // dataURL
      note: "",
      capa_action: "",
      responsible: "",
      due_date: "",
      closed: false
    }))
  };

  // ========= Helpers =========
  function badgeForDecision(decision){
    const el = $("decisionBadge");
    el.classList.remove("b-ok","b-warn","b-bad");
    if(decision.startsWith("ğŸŸ¢")){
      el.classList.add("b-ok");
    }else if(decision.startsWith("ğŸŸ ")){
      el.classList.add("b-warn");
    }else if(decision.startsWith("ğŸ”´")){
      el.classList.add("b-bad");
    }
    el.textContent = decision;
  }

  function compute(){
    const total = state.items.length || 1;
    let sum = 0, violations=0, improve=0, openCapa=0;

    state.items.forEach(it=>{
      sum += points[it.status] ?? 0;
      if(it.status === "violation") violations++;
      if(it.status === "improvement") improve++;

      const hasCapa = (it.capa_action?.trim() || it.note?.trim() || it.responsible?.trim() || it.due_date?.trim());
      const shouldTrack = (it.status !== "compliant") && hasCapa;
      if(shouldTrack && !it.closed) openCapa++;
    });

    const score = Math.round((sum / (total * 100)) * 100);
    $("scoreValue").textContent = score + "%";
    $("violationsValue").textContent = violations;
    $("improveValue").textContent = improve;
    $("openCapaValue").textContent = openCapa;

    let decision = "ğŸŸ¢ Ù…Ø³ØªÙ…Ø±";
    if(score < 60) decision = "ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ÙŠ";
    else if(score < 80) decision = "ğŸŸ  Ø®Ø·Ø© ØªØµØ­ÙŠØ­ Ø¥Ù„Ø²Ø§Ù…ÙŠØ©";
    badgeForDecision(decision);

    return {score, decision, violations, improve, openCapa};
  }

  function readMeta(){
    state.meta.brand = $("brand").value.trim();
    state.meta.branch = $("branch").value.trim();
    state.meta.city = $("city").value.trim();
    state.meta.visit_date = $("visit_date").value;
    state.meta.operator_name = $("operator_name").value.trim();
    state.meta.visit_type = $("visit_type").value;
    state.meta.check_in_time = $("check_in_time").value;
    state.meta.check_out_time = $("check_out_time").value;
    state.meta.summary = $("summary").value.trim();
  }

  function validateRequired(){
    readMeta();
    const missing = [];
    if(!state.meta.brand) missing.push("Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯");
    if(!state.meta.branch) missing.push("Ø§Ù„ÙØ±Ø¹");
    if(!state.meta.visit_date) missing.push("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©");
    if(!state.meta.operator_name) missing.push("Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØºÙ‘Ù„");

    if(missing.length){
      alert("Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù†Ø§Ù‚ØµØ©: " + missing.join("ØŒ "));
      return false;
    }
    return true;
  }

  function toDataURL(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ========= Render =========
  function render(){
    itemsBody.innerHTML = "";
    state.items.forEach((it, idx)=>{
      const tr = document.createElement("tr");

      const tdTitle = document.createElement("td");
      tdTitle.innerHTML = `
        <div class="item-title">${it.item_id} â€” ${it.title}</div>
        <div class="mini">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ø®Ø·ÙˆØ±Ø© ÙˆØ£Ø¶Ù ØµÙˆØ±Ø© + CAPA Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</div>
      `;

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = `
        <select data-k="status" data-i="${idx}">
          <option value="compliant">âœ… Ù…Ø·Ø§Ø¨Ù‚</option>
          <option value="improvement">âš ï¸ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†</option>
          <option value="violation">âŒ Ù…Ø®Ø§Ù„ÙØ©</option>
        </select>
        <div class="mini">Ø§Ù„Ù†Ù‚Ø§Ø·: 100 / 50 / 0</div>
      `;

      const tdRisk = document.createElement("td");
      tdRisk.innerHTML = `
        <select data-k="risk_level" data-i="${idx}">
          <option value="low">Ù…Ù†Ø®ÙØ¶</option>
          <option value="medium">Ù…ØªÙˆØ³Ø·</option>
          <option value="high">Ø¹Ø§Ù„ÙŠ</option>
        </select>
      `;

      const tdPhoto = document.createElement("td");
      tdPhoto.innerHTML = `
        <div class="file">
          <input type="file" accept="image/*" data-k="photo" data-i="${idx}" style="max-width:190px">
          ${it.photo ? `<img class="thumb" src="${it.photo}" alt="ØµÙˆØ±Ø©">` : `<span class="pill">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</span>`}
        </div>
      `;

      const tdNote = document.createElement("td");
      tdNote.innerHTML = `
        <div class="row" style="gap:8px">
          <input placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" value="${escapeHtml(it.note)}" data-k="note" data-i="${idx}">
          <input placeholder="Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ (CAPA)" value="${escapeHtml(it.capa_action)}" data-k="capa_action" data-i="${idx}">
          <div class="row cols-2">
            <input placeholder="Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" value="${escapeHtml(it.responsible)}" data-k="responsible" data-i="${idx}">
            <input type="date" value="${it.due_date || ""}" data-k="due_date" data-i="${idx}">
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label style="margin:0;color:var(--muted);font-size:12px;font-weight:900">
              <input type="checkbox" data-k="closed" data-i="${idx}" ${it.closed ? "checked":""} style="width:auto;vertical-align:middle;margin-left:6px">
              ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            </label>
            <span class="mini">ÙŠÙØ­Ø³Ø¨ CAPA ÙÙ‚Ø· Ø¹Ù†Ø¯ (ØªØ­Ø³ÙŠÙ†/Ù…Ø®Ø§Ù„ÙØ©) + ÙˆØ¬ÙˆØ¯ Ø¥Ø¬Ø±Ø§Ø¡/Ù…Ù„Ø§Ø­Ø¸Ø©.</span>
          </div>
        </div>
      `;

      tr.appendChild(tdTitle);
      tr.appendChild(tdStatus);
      tr.appendChild(tdRisk);
      tr.appendChild(tdPhoto);
      tr.appendChild(tdNote);

      itemsBody.appendChild(tr);

      // set current selects
      tdStatus.querySelector("select").value = it.status;
      tdRisk.querySelector("select").value = it.risk_level;
    });

    compute();
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  // ========= Events =========
  document.addEventListener("input", async (e)=>{
    const el = e.target;
    const i = el.getAttribute("data-i");
    const k = el.getAttribute("data-k");
    if(i === null || !k) return;

    const idx = Number(i);
    if(!state.items[idx]) return;

    if(k === "photo"){
      const file = el.files && el.files[0];
      if(file){
        state.items[idx].photo = await toDataURL(file);
      }
      render();
      return;
    }

    if(k === "closed"){
      state.items[idx][k] = el.checked;
    }else{
      state.items[idx][k] = el.value;
      // Ø¥Ø°Ø§ Ø±Ø¬Ø¹ Ø§Ù„Ø¨Ù†Ø¯ "Ù…Ø·Ø§Ø¨Ù‚" Ù†Ø®Ù„ÙŠ CAPA Ù…Ù‚ÙÙ„Ø© Ù…Ù†Ø·Ù‚ÙŠÙ‹Ø§
      if(k === "status" && el.value === "compliant"){
        state.items[idx].closed = true;
      }
      if(k === "status" && el.value !== "compliant"){
        // Ù„Ø§ Ù†Ø¬Ø¨Ø±Ù‡ ÙŠÙØªØ­ØŒ ÙÙ‚Ø· Ù†Ø®Ù„ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
      }
    }

    compute();
  });

  ["brand","branch","city","visit_date","operator_name","visit_type","check_in_time","check_out_time","summary"]
    .forEach(id=>{
      $(id).addEventListener("input", ()=>{ readMeta(); });
      $(id).addEventListener("change", ()=>{ readMeta(); });
    });

  $("markAllCompliant").addEventListener("click", ()=>{
    state.items.forEach(it=>{
      it.status="compliant"; it.risk_level="low"; it.closed=true;
    });
    render();
  });

  $("markAllNeedsImprove").addEventListener("click", ()=>{
    state.items.forEach(it=>{
      it.status="improvement"; it.risk_level="medium"; it.closed=false;
    });
    render();
  });

  $("resetAll").addEventListener("click", ()=>{
    if(!confirm("ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
    state.meta = { brand:"", branch:"", city:"", visit_date:"", operator_name:"",
      visit_type:"ØªØ´ØºÙŠÙ„ÙŠØ©", check_in_time:"", check_out_time:"", summary:"" };
    $("brand").value=""; $("branch").value=""; $("city").value="";
    $("visit_date").value=""; $("operator_name").value="";
    $("visit_type").value="ØªØ´ØºÙŠÙ„ÙŠØ©"; $("check_in_time").value=""; $("check_out_time").value="";
    $("summary").value="";
    state.items = ITEMS.map(x=>({
      item_id:x.id,title:x.title,status:"compliant",risk_level:"low",photo:"",
      note:"",capa_action:"",responsible:"",due_date:"",closed:false
    }));
    render();
  });

  // ===== Theme =====
  const THEME_KEY = "nasaq_visits_theme";
  function setTheme(mode){
    document.documentElement.setAttribute("data-theme", mode);
    localStorage.setItem(THEME_KEY, mode);
  }
  $("toggleTheme").addEventListener("click", ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  });
  setTheme(localStorage.getItem(THEME_KEY) || "dark");

  // ===== Draft Save/Load =====
  const DRAFT_KEY = "nasaq_visit_draft_v1";
  $("saveDraft").addEventListener("click", ()=>{
    readMeta();
    localStorage.setItem(DRAFT_KEY, JSON.stringify(state));
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© âœ…");
  });
  $("loadDraft").addEventListener("click", ()=>{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©.");
    const data = JSON.parse(raw);
    if(!data?.items?.length) return alert("Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸ ØºÙŠØ± ØµØ§Ù„Ø­.");
    Object.assign(state.meta, data.meta || {});
    state.items = data.items;

    // push meta to inputs
    $("brand").value = state.meta.brand || "";
    $("branch").value = state.meta.branch || "";
    $("city").value = state.meta.city || "";
    $("visit_date").value = state.meta.visit_date || "";
    $("operator_name").value = state.meta.operator_name || "";
    $("visit_type").value = state.meta.visit_type || "ØªØ´ØºÙŠÙ„ÙŠØ©";
    $("check_in_time").value = state.meta.check_in_time || "";
    $("check_out_time").value = state.meta.check_out_time || "";
    $("summary").value = state.meta.summary || "";

    render();
    alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ âœ…");
  });

  // ===== Download JSON =====
  $("downloadJson").addEventListener("click", ()=>{
    readMeta();
    const {score, decision} = compute();
    const payload = {
      ...state,
      computed: {score, decision},
      exported_at: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const safeName = `nasaq-visit-${(state.meta.branch||"branch").replace(/\s+/g,"-")}-${state.meta.visit_date||"date"}.json`;
    a.download = safeName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ===== Print PDF =====
  $("printPdf").addEventListener("click", ()=>{
    if(!validateRequired()) return;
    readMeta();
    const {score, decision} = compute();

    // Build print summary
    const lines = [];
    lines.push(`<div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div><strong>Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯:</strong> ${escapeHtml(state.meta.brand)} â€” <strong>Ø§Ù„ÙØ±Ø¹:</strong> ${escapeHtml(state.meta.branch)} â€” <strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${escapeHtml(state.meta.city||"-")}</div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${escapeHtml(state.meta.visit_date)} â€” <strong>Ø§Ù„Ù…Ø´ØºÙ‘Ù„:</strong> ${escapeHtml(state.meta.operator_name)} â€” <strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${escapeHtml(state.meta.visit_type)}</div>
    </div>`);
    lines.push(`<hr style="border:none;border-top:1px solid #ddd;margin:10px 0">`);
    lines.push(`<div><strong>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ${score}% â€” <strong>Ø§Ù„Ù‚Ø±Ø§Ø±:</strong> ${escapeHtml(decision)}</div>`);
    if(state.meta.summary){
      lines.push(`<div style="margin-top:8px"><strong>Ù…Ù„Ø®Øµ:</strong> ${escapeHtml(state.meta.summary)}</div>`);
    }

    // Violations & CAPA
    const highlights = state.items.filter(it => it.status !== "compliant");
    if(highlights.length){
      lines.push(`<h3 style="margin:12px 0 6px 0">Ø£Ù‡Ù… Ø§Ù„Ø¨Ù†ÙˆØ¯ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h3>`);
      lines.push(`<ol style="margin:0;padding-right:18px">` +
        highlights.map(it=>{
          const st = it.status === "violation" ? "Ù…Ø®Ø§Ù„ÙØ©" : "ØªØ­Ø³ÙŠÙ†";
          const rk = it.risk_level === "high" ? "Ø¹Ø§Ù„ÙŠ" : it.risk_level === "medium" ? "Ù…ØªÙˆØ³Ø·" : "Ù…Ù†Ø®ÙØ¶";
          return `<li style="margin:6px 0">
            <strong>${escapeHtml(it.item_id)}:</strong> ${escapeHtml(it.title)}
            â€” <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${st} â€” <strong>Ø§Ù„Ø®Ø·ÙˆØ±Ø©:</strong> ${rk}
            ${it.capa_action ? `<br><strong>CAPA:</strong> ${escapeHtml(it.capa_action)}` : ""}
            ${it.responsible ? ` â€” <strong>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${escapeHtml(it.responsible)}` : ""}
            ${it.due_date ? ` â€” <strong>Ø§Ù„Ù…ÙˆØ¹Ø¯:</strong> ${escapeHtml(it.due_date)}` : ""}
          </li>`;
        }).join("") +
      `</ol>`);
    } else {
      lines.push(`<div style="margin-top:10px"><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© âœ…</div>`);
    }

    $("printSummary").innerHTML = lines.join("");
    window.print();
  });

  // init meta defaults
  $("visit_date").valueAsDate = new Date();

  // initial render
  render();
</script>
</body>
</html>
