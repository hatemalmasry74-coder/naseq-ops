<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>منصة نسق – لوحة التحكم</title>

  <!-- NASAQ Brand Theme -->
  <link rel="stylesheet" href="nasaq-theme.css">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
</head>

  <div class="topbar">
    <div class="brand">
      <div class="logo">ن</div>
      <div>
        <div style="font-weight:900">غرفة عمليات نَسَق</div>
        <div class="muted">Pilot: طوبى • سدف • دبل بي — (عربي/RTL)</div>
      </div>
    </div>
    <div class="badge">MVP محلي (Prototype)</div>
  </div>

  <div class="container">
    <div class="nav" style="margin-bottom:14px">
      <a data-nav href="index.html">لوحة التحكم</a>
      <a data-nav href="visits.html">الزيارات</a>
      <a data-nav href="issues.html">الملاحظات &amp; CAPA</a>
      <a data-nav href="tasks.html">المهام</a>
      <a data-nav href="cleaning.html">النظافة اليومية</a>
      <a data-nav href="sop.html">مكتبة SOP</a>
      <a data-nav href="settings.html">الإعدادات</a>
    </div>
<div class="grid">
  <div class="card" style="grid-column: span 4">
    <h3>ملاحظات حرجة</h3>
    <div class="kpi"><div class="num" id="kpiCritical">0</div><div class="pill danger">عالي</div></div>
    <div class="muted">عدد الملاحظات بدرجة خطورة عالية ولم تُغلق بعد.</div>
  </div>
  <div class="card" style="grid-column: span 4">
    <h3>ملاحظات متأخرة</h3>
    <div class="kpi"><div class="num" id="kpiOverdue">0</div><div class="pill warn">متأخر</div></div>
    <div class="muted">ملاحظات تجاوزت تاريخ الإغلاق المطلوب.</div>
  </div>
  <div class="card" style="grid-column: span 4">
    <h3>مهام اليوم</h3>
    <div class="kpi"><div class="num"><span id="kpiDone">0</span>/<span id="kpiToday">0</span></div><div class="pill ok">منجز</div></div>
    <div class="muted">نسبة المهام المنجزة اليوم (حسب تاريخ الاستحقاق).</div>
  </div>

  <div class="card" style="grid-column: span 7">
    <h3>ملخص سريع</h3>
    <div class="row">
      <div class="pill">إجمالي الملاحظات المفتوحة: <b id="kpiOpen">0</b></div>
      <div class="pill">تجربة Pilot: 3 براندات / 3 فروع</div>
    </div>
    <hr/>
    <div class="muted">ابدأ بإضافة زيارة جديدة، وسيتم إنشاء الملاحظات والإجراءات التصحيحية تلقائيًا.</div>
    <div class="row" style="margin-top:10px">
      <a class="btn" href="visits.html">+ إنشاء زيارة</a>
      <a class="btn secondary" href="issues.html">عرض الملاحظات</a>
      <a class="btn secondary" href="tasks.html">إدارة المهام</a>
    </div>
  </div>

  <div class="card" style="grid-column: span 5">
    <h3>أدوات</h3>
    <div class="muted">تصدير/استيراد البيانات لتجربة المشاركة بين الأجهزة.</div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="downloadJSON()">تصدير البيانات (JSON)</button>
      <label class="btn secondary" style="display:inline-flex;align-items:center;gap:8px">
        استيراد
        <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importJSON(this.files[0])"/>
      </label>
      <button class="btn danger" onclick="if(confirm('سيتم إعادة ضبط البيانات!')){ localStorage.removeItem(DB_KEY); location.reload(); }">إعادة ضبط</button>
    </div>
  </div>
</div>


    <div class="footer">
      هذا نموذج أولي محلي لتجربة الفكرة. البيانات تُحفظ في المتصفح (LocalStorage). للاستخدام الفعلي على الإنترنت نحتاج استضافة + قاعدة بيانات + صلاحيات.
    </div>
  </div>

  <script>
const DB_KEY = "naseq_ops_db_v1";

function nowISO(){
  const d = new Date();
  return d.toISOString();
}

function seedDB(){
  const seeded = {
    meta: { createdAt: nowISO(), language: "ar", pilot: true },
    brands: [
      { id: "tuba", name: "طوبى", branches:[{id:"tuba-main", name:"طوبى – الفرع الرئيسي"}]},
      { id: "sdf", name: "سدف", branches:[{id:"sdf-main", name:"سدف – الفرع الرئيسي"}]},
      { id: "dbb", name: "دبل بي", branches:[{id:"dbb-main", name:"دبل بي – الفرع الرئيسي"}]},
    ],
    users: [
      { id:"admin", name:"نَسَق (Admin)", role:"admin" }
    ],
    visits: [],
    issues: [],
    tasks: [],
    cleaningLogs: [],
    sops: [
      { id:"fridge-temp", title:"درجة حرارة الثلاجة", content:"الهدف: 1–4° م (حسب السياسة الداخلية). سجّل تاريخ الفتح وتابع الصلاحية بعد الفتح." },
      { id:"invoice", title:"التأكد من الفاتورة الضريبية", content:"اسم المنشأة + الرقم الضريبي + التاريخ + الإجمالي + مطابقة الصرف." }
    ]
  };
  localStorage.setItem(DB_KEY, JSON.stringify(seeded));
  return seeded;
}

function loadDB(){
  const raw = localStorage.getItem(DB_KEY);
  if(!raw) return seedDB();
  try { return JSON.parse(raw); } catch(e){ return seedDB(); }
}

function saveDB(db){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }

function setActiveNav(){
  const path = location.pathname.split("/").pop() || "index.html";
  $all("[data-nav]").forEach(a => {
    if(a.getAttribute("href") === path) a.classList.add("active");
  });
}

function renderBrandBranchSelectors(brandSelId, branchSelId){
  const db = loadDB();
  const brandSel = document.getElementById(brandSelId);
  const branchSel = document.getElementById(branchSelId);
  if(!brandSel || !branchSel) return;

  brandSel.innerHTML = db.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  function fillBranches(){
    const b = db.brands.find(x=>x.id===brandSel.value);
    branchSel.innerHTML = (b?.branches||[]).map(br=>`<option value="${br.id}">${br.name}</option>`).join("");
  }
  brandSel.addEventListener("change", fillBranches);
  fillBranches();
}

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("ar-SA");
  }catch(e){ return iso; }
}

function statusPill(status){
  const map = {
    "مفتوح": "danger",
    "متأخر": "warn",
    "مغلق": "ok",
    "جديد": "warn",
    "قيد التنفيذ": "warn",
    "منجز": "ok"
  };
  const cls = map[status] || "";
  return `<span class="pill ${cls}">${status}</span>`;
}

function brandName(id){
  const db = loadDB();
  return db.brands.find(b=>b.id===id)?.name || id;
}

function branchName(brandId, branchId){
  const db = loadDB();
  const b = db.brands.find(x=>x.id===brandId);
  return b?.branches?.find(br=>br.id===branchId)?.name || branchId;
}

function computeDashboard(){
  const db = loadDB();
  const openIssues = db.issues.filter(i=>i.status!=="مغلق");
  const overdueIssues = db.issues.filter(i=>i.status==="متأخر");
  const critical = db.issues.filter(i=>i.severity==="عالي" && i.status!=="مغلق");
  const today = new Date().toISOString().slice(0,10);
  const todayTasks = db.tasks.filter(t=> (t.dueDate||"").slice(0,10)===today );
  const doneToday = todayTasks.filter(t=>t.status==="منجز").length;

  return { openIssues: openIssues.length, overdueIssues: overdueIssues.length, critical: critical.length, todayTasks: todayTasks.length, doneToday };
}

function downloadJSON(){
  const db = loadDB();
  const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "naseq_ops_export.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      localStorage.setItem(DB_KEY, JSON.stringify(obj));
      alert("تم الاستيراد بنجاح ✅");
      location.reload();
    }catch(e){
      alert("ملف غير صالح");
    }
  };
  reader.readAsText(file);
}
</script>
  <script>
    setActiveNav();
    
const k = computeDashboard();
document.getElementById("kpiCritical").textContent = k.critical;
document.getElementById("kpiOverdue").textContent = k.overdueIssues;
document.getElementById("kpiToday").textContent = k.todayTasks;
document.getElementById("kpiDone").textContent = k.doneToday;
document.getElementById("kpiOpen").textContent = k.openIssues;

  </script>
</body>
</html>
