<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Ù…Ù†ØµØ© Ù†Ø³Ù‚ â€“ Ù„ÙˆØ­Ø© CEO</title>

  <!-- NASAQ Brand Theme -->
  <link rel="stylesheet" href="nasaq-theme.css">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:var(--nasaq-primary);color:#fff;display:grid;place-items:center;font-weight:900}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border-light);background:#fff}

    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .nav a{padding:10px 12px;border-radius:12px;border:1px solid var(--border-light);background:#fff;text-decoration:none}
    .nav a.active{background:rgba(193,33,38,.08);border-color:rgba(193,33,38,.35)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .kpi{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .kpi .num{font-size:28px;font-weight:900}
    .muted{color:var(--text-muted)}
    .small{font-size:12px}
    .chip{padding:8px 10px;border:1px solid var(--border-light);border-radius:999px;background:#fff;cursor:pointer}
    .chip.active{background:rgba(193,33,38,.08);border-color:rgba(193,33,38,.35)}
    .select{padding:10px 12px;border-radius:10px;border:1px solid var(--border-light);background:#fff;outline:none}
    .btn{background:var(--nasaq-primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}

    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border-light);display:inline-block}
    .pill.ok{background:rgba(46,125,50,.08);border-color:rgba(46,125,50,.35)}
    .pill.warn{background:rgba(237,108,2,.08);border-color:rgba(237,108,2,.35)}
    .pill.danger{background:rgba(193,33,38,.08);border-color:rgba(193,33,38,.45)}
    .pill.neutral{background:rgba(0,0,0,.04)}

    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .table th{font-size:12px;color:var(--text-muted);text-align:right}
    .table td{
      background:#fff;border:1px solid var(--border-light);
      padding:10px;border-left:none;border-right:none;vertical-align:top
    }
    .table tr td:first-child{
      border-right:1px solid var(--border-light);
      border-top-right-radius:10px;border-bottom-right-radius:10px
    }
    .table tr td:last-child{
      border-left:1px solid var(--border-light);
      border-top-left-radius:10px;border-bottom-left-radius:10px
    }

    .alertBox{display:flex;flex-direction:column;gap:10px}
    .alertItem{background:#fff;border:1px solid var(--border-light);border-radius:14px;padding:12px}
    .alertTitle{font-weight:800;margin-bottom:6px}
    .footer{margin-top:18px;color:var(--text-muted);font-size:12px}

    @media (max-width:900px){
      .topbar{flex-direction:column;align-items:flex-start;gap:10px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">Ù†</div>
      <div>
        <div style="font-weight:900">ØºØ±ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ù†ÙØ³ÙÙ‚</div>
        <div class="muted">CEO Dashboard â€” Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø¢Ù† (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§)</div>
      </div>
    </div>
    <div class="badge">MVP Ù…Ø­Ù„ÙŠ</div>
  </div>

  <div class="container">
    <div class="nav">
      <a data-nav href="index.html">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a data-nav href="visits.html">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</a>
      <a data-nav href="issues.html">CAPA & Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</a>
      <a data-nav href="tasks.html">Ø§Ù„Ù…Ù‡Ø§Ù…</a>
      <a data-nav href="cleaning.html">Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</a>
      <a data-nav href="sop.html">Ù…ÙƒØªØ¨Ø© SOP</a>
      <a data-nav href="settings.html">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    </div>

    <!-- Controls -->
    <div class="card" style="margin-bottom:14px">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip active" data-range="today">Ø§Ù„ÙŠÙˆÙ…</span>
          <span class="chip" data-range="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span>
          <span class="chip" data-range="all">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>

        <div class="row">
          <select id="brandFilter" class="select" style="min-width:220px">
            <option value="">ÙƒÙ„ Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª</option>
          </select>
          <button class="btn" type="button" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù„ÙˆØ­Ø© Ù‚Ø±Ø§Ø± (Decision Dashboard) â€” ØªØ¹Ø±Ø¶ Ø£Ù‡Ù… Ù…Ø§ ÙŠØ­ØªØ§Ø¬Ù‡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø¨Ø³Ø±Ø¹Ø©.
      </div>
    </div>

    <!-- KPI -->
    <div class="grid" style="margin-bottom:14px">
      <div class="card" style="grid-column:span 3">
        <div class="kpi">
          <div>
            <div class="small muted">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</div>
            <div class="num" id="kpiOpenIssues">â€”</div>
            <div class="small muted" id="kpiOpenIssuesHint">â€”</div>
          </div>
          <div class="pill danger">Open</div>
        </div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="kpi">
          <div>
            <div class="small muted">CAPA Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</div>
            <div class="num" id="kpiOverdue">â€”</div>
            <div class="small muted" id="kpiOverdueHint">â€”</div>
          </div>
          <div class="pill warn">Overdue</div>
        </div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="kpi">
          <div>
            <div class="small muted">Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ©</div>
            <div class="num" id="kpiCleaningPct">â€”</div>
            <div class="small muted" id="kpiCleaningHint">â€”</div>
          </div>
          <div class="pill ok">Hygiene</div>
        </div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="kpi">
          <div>
            <div class="small muted">Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="num" id="kpiTasksToday">â€”</div>
            <div class="small muted" id="kpiTasksHint">â€”</div>
          </div>
          <div class="pill neutral">Tasks</div>
        </div>
      </div>
    </div>

    <!-- Alerts + Top list -->
    <div class="grid">
      <div class="card" style="grid-column:span 5">
        <h3 style="margin:0 0 8px 0">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø°ÙƒÙŠØ©</h3>
        <div class="small muted" style="margin-bottom:10px">Ù…Ù„Ø®Øµ Ù„Ù…Ø§ ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù‘Ù„ Ø³Ø±ÙŠØ¹.</div>
        <div class="alertBox" id="alertsBox"></div>
      </div>

      <div class="card" style="grid-column:span 7">
        <h3 style="margin:0 0 8px 0">Ø£Ù‡Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± (Top 5)</h3>
        <div class="small muted" style="margin-bottom:10px">Ù…Ø®ØªØµØ± ØªÙ†ÙÙŠØ°ÙŠ: Ø£ÙƒØ«Ø± Ù…Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†.</div>

        <table class="table">
          <thead>
            <tr>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯</th>
              <th>Ø§Ù„ÙˆØµÙ</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¹Ù…Ø±</th>
            </tr>
          </thead>
          <tbody id="topTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙÙ‚Ø±Ø£ Ù…Ù† LocalStorage. Ù„Ù„Ù†Ø³Ø®Ø© Production Ø³Ù†Ø±Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª + ØµÙ„Ø§Ø­ÙŠØ§Øª + Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.
    </div>
  </div>

<script>
  // ========= Language-ready foundation (Arabic now, English later) =========
  const I18N = {
    ar: {
      noData: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©",
      allBrands: "ÙƒÙ„ Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª",
      openIssues: "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©",
      overdue: "Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©",
      cleaning: "Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ù†Ø¸Ø§ÙØ©",
      tasksToday: "Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…",
      alert: "ØªÙ†Ø¨ÙŠÙ‡",
      ok: "Ù…Ù…ØªØ§Ø²",
      needsAttention: "ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„",
      type_issue: "Ù…Ù„Ø§Ø­Ø¸Ø© / CAPA",
      type_cleaning: "Ù†Ø¸Ø§ÙØ©",
      type_task: "Ù…Ù‡Ù…Ø©"
    }
    // en: {...} // later
  };
  const LANG = "ar";
  const t = (k)=> (I18N[LANG] && I18N[LANG][k]) ? I18N[LANG][k] : k;

  // ========= DB helpers =========
  const DB_KEY = "naseq_ops_db_v1";

  const now = () => new Date();
  const nowISO = () => new Date().toISOString();

  function seed(){
    // This seed is safe; only runs if DB not found.
    const db = {
      brands:[
        {id:"tuba",name:"Ø·ÙˆØ¨Ù‰",branches:[{id:"main",name:"Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"}]},
        {id:"sdf",name:"Ø³Ø¯Ù",branches:[{id:"main",name:"Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"}]},
        {id:"dbb",name:"Ø¯Ø¨Ù„ Ø¨ÙŠ",branches:[{id:"main",name:"Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"}]}
      ],
      cleaningLogs:[],
      issues:[],
      tasks:[],
      visits:[]
    };
    localStorage.setItem(DB_KEY, JSON.stringify(db));
    return db;
  }

  function loadDB(){
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return seed();
    try { return JSON.parse(raw) || seed(); } catch(e){ return seed(); }
  }

  // ========= Date range =========
  function startOfToday(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  }

  function startOfWeek(){
    // Week starts on Saturday in KSA context? We'll use Monday-neutral simple:
    // Set to last 7 days window (practical for MVP).
    const d = new Date();
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() - 6);
    return d;
  }

  function withinRange(iso, range){
    if(!iso) return false;
    const d = new Date(iso);
    if(range === "all") return true;
    const from = (range === "today") ? startOfToday() : startOfWeek();
    return d >= from;
  }

  function ageLabel(iso){
    if(!iso) return "â€”";
    const ms = now() - new Date(iso);
    const mins = Math.floor(ms/60000);
    if(mins < 60) return `${mins} Ø¯`;
    const hrs = Math.floor(mins/60);
    if(hrs < 24) return `${hrs} Ø³`;
    const days = Math.floor(hrs/24);
    return `${days} ÙŠÙˆÙ…`;
  }

  // ========= Nav active =========
  function setActiveNav(){
    const path = location.pathname.split("/").pop() || "index.html";
    document.querySelectorAll("[data-nav]").forEach(a=>{
      if(a.getAttribute("href") === path) a.classList.add("active");
    });
  }

  // ========= Filters =========
  let RANGE = "today";
  let BRAND = "";

  function fillBrandFilter(){
    const db = loadDB();
    const sel = document.getElementById("brandFilter");
    sel.innerHTML = `<option value="">${t("allBrands")}</option>`;
    (db.brands||[]).forEach(b=>{
      sel.add(new Option(b.name, b.id));
    });
    sel.value = BRAND || "";
  }

  function brandNameById(id){
    const db = loadDB();
    return (db.brands||[]).find(b=>b.id===id)?.name || id || "â€”";
  }

  // Best effort: cleaning record stores brand text, not id, in your current cleaning.html.
  // We'll filter by brandId if exists; else by brand text.
  function brandMatch(recordBrandId, recordBrandText){
    if(!BRAND) return true;
    if(recordBrandId) return recordBrandId === BRAND;
    const target = brandNameById(BRAND);
    return (recordBrandText||"") === target;
  }

  // ========= KPI computation =========
  function compute(){
    const db = loadDB();

    const issues = (db.issues||[])
      .filter(i => brandMatch(i.brandId, i.brand))
      .filter(i => withinRange(i.createdAt || i.date || i.openedAt, RANGE));

    // We'll treat issue status:
    // - closed if status is "Ù…ØºÙ„Ù‚" or "Ù…Ù†Ø¬Ø²" or "Closed"
    // - overdue if status is "Ù…ØªØ£Ø®Ø±" or (dueDate passed and not closed)
    const isClosed = (s)=> ["Ù…ØºÙ„Ù‚","Ù…Ù†Ø¬Ø²","closed","done"].includes(String(s||"").toLowerCase());
    const openIssues = issues.filter(i => !isClosed(i.status));
    const overdueIssues = issues.filter(i => {
      if(isClosed(i.status)) return false;
      const st = String(i.status||"");
      if(st.includes("Ù…ØªØ£Ø®Ø±")) return true;
      if(i.dueDate){
        return new Date(i.dueDate) < now();
      }
      return false;
    });

    // Cleaning: your cleaning.html stores cleaningLogs with createdAt + done ("ØªÙ…/Ø¬Ø²Ø¦ÙŠ/Ù„Ù… ÙŠØªÙ…") + brand text
    const cleaning = (db.cleaningLogs||[])
      .filter(r => brandMatch(r.brandId, r.brand))
      .filter(r => withinRange(r.createdAt, RANGE));

    const cleaningTotal = cleaning.length;
    const cleaningDone = cleaning.filter(r => r.done === "ØªÙ…").length;
    const cleaningPct = cleaningTotal ? Math.round((cleaningDone/cleaningTotal)*100) : null;

    // Tasks: best effort (some DBs may not have tasks yet)
    const tasks = (db.tasks||[])
      .filter(t => brandMatch(t.brandId, t.brand))
      .filter(t => withinRange(t.createdAt || t.dueDate, RANGE));

    // "today tasks": dueDate is preferred; fallback createdAt
    const todayISO = new Date().toISOString().slice(0,10);
    const tasksToday = (db.tasks||[]).filter(t => {
      if(!brandMatch(t.brandId, t.brand)) return false;
      const key = (t.dueDate || t.createdAt || "").slice(0,10);
      return key === todayISO;
    });
    const doneToday = tasksToday.filter(t => ["Ù…Ù†Ø¬Ø²","done","ØªÙ…"].includes(String(t.status||"").toLowerCase())).length;

    return {
      db,
      openIssuesCount: openIssues.length,
      overdueCount: overdueIssues.length,
      cleaningTotal,
      cleaningDone,
      cleaningPct,
      tasksTodayCount: tasksToday.length,
      tasksDoneToday: doneToday,
      issuesOpen: openIssues,
      issuesOverdue: overdueIssues,
      cleaning,
      tasksToday
    };
  }

  function pill(cls, text){
    return `<span class="pill ${cls}">${text}</span>`;
  }

  function renderKPIs(state){
    const kOpen = document.getElementById("kpiOpenIssues");
    const kOver = document.getElementById("kpiOverdue");
    const kClean = document.getElementById("kpiCleaningPct");
    const kTasks = document.getElementById("kpiTasksToday");

    const hOpen = document.getElementById("kpiOpenIssuesHint");
    const hOver = document.getElementById("kpiOverdueHint");
    const hClean = document.getElementById("kpiCleaningHint");
    const hTasks = document.getElementById("kpiTasksHint");

    kOpen.textContent = state.openIssuesCount;
    hOpen.textContent = RANGE === "today" ? "Ù…ÙØªÙˆØ­Ø© Ø§Ù„ÙŠÙˆÙ…" : (RANGE === "week" ? "Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…" : "Ø¥Ø¬Ù…Ø§Ù„ÙŠ");

    kOver.textContent = state.overdueCount;
    hOver.textContent = state.overdueCount ? "ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ÙÙˆØ±ÙŠØ©" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±";

    if(state.cleaningPct === null){
      kClean.textContent = "â€”";
      hClean.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰";
    } else {
      kClean.textContent = state.cleaningPct + "%";
      hClean.textContent = `${state.cleaningDone}/${state.cleaningTotal} ØªÙ…`;
    }

    kTasks.textContent = state.tasksDoneToday + "/" + state.tasksTodayCount;
    hTasks.textContent = state.tasksTodayCount ? "Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…";
  }

  function renderAlerts(state){
    const box = document.getElementById("alertsBox");
    const alerts = [];

    // 1) Overdue CAPA
    if(state.overdueCount > 0){
      alerts.push({
        title: `âš  ${state.overdueCount} CAPA Ù…ØªØ£Ø®Ø±Ø©`,
        body: "ÙŠÙˆØµÙ‰ Ø¨ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø¤ÙˆÙ„ + Ù…ÙˆØ¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ + Ø§Ø¹ØªÙ…Ø§Ø¯.",
        cls: "warn"
      });
    }

    // 2) Cleaning failures today
    const fail = state.cleaning.filter(r => r.done !== "ØªÙ…");
    if(fail.length > 0){
      // group by brand name
      const byBrand = {};
      fail.forEach(r=>{
        const b = r.brand || "â€”";
        byBrand[b] = (byBrand[b]||0)+1;
      });
      const top = Object.entries(byBrand).sort((a,b)=>b[1]-a[1])[0];
      alerts.push({
        title: `â— Ù†Ø¸Ø§ÙØ© ØºÙŠØ± Ù…Ù„ØªØ²Ù…Ø©: ${fail.length} Ø³Ø¬Ù„`,
        body: top ? `Ø§Ù„Ø£ÙƒØ«Ø± ØªØ£Ø«ÙŠØ±Ù‹Ø§: ${top[0]} (${top[1]})` : "Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„ØªÙØ§ØµÙŠÙ„.",
        cls: "danger"
      });
    } else if(state.cleaningTotal > 0){
      alerts.push({
        title: `âœ… Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰ Ù…Ù…ØªØ§Ø²Ø©`,
        body: `Ø§Ù„ØªØ²Ø§Ù… ${state.cleaningPct}% Ø¶Ù…Ù† (${state.cleaningTotal}) Ø³Ø¬Ù„.`,
        cls: "ok"
      });
    }

    // 3) Open issues
    if(state.openIssuesCount > 0){
      alerts.push({
        title: `ğŸ”´ ${state.openIssuesCount} Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ÙØªÙˆØ­Ø©`,
        body: "Ø§Ù‚ØªØ±Ø§Ø­: Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙˆÙ„ÙˆÙŠØ© (Ø¹Ø§Ù„ÙŠ/Ù…ØªÙˆØ³Ø·/Ù…Ù†Ø®ÙØ¶) ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø®Ø·Ø© CAPA.",
        cls: "danger"
      });
    } else {
      alerts.push({
        title: `âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰`,
        body: "Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù†ÙØ³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
        cls: "ok"
      });
    }

    box.innerHTML = alerts.slice(0,4).map(a=>`
      <div class="alertItem">
        <div class="alertTitle">${a.title} ${pill(a.cls, a.cls==="ok"?"OK":a.cls==="warn"?"ØªÙ†Ø¨ÙŠÙ‡":"Ø­Ø±Ø¬")}</div>
        <div class="small muted">${a.body}</div>
      </div>
    `).join("") || `
      <div class="alertItem">
        <div class="alertTitle">${t("noData")}</div>
        <div class="small muted">Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§ÙØ©/Ø§Ù„Ù…Ù‡Ø§Ù…/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„.</div>
      </div>
    `;
  }

  function topItems(state){
    const items = [];

    // Issues: prioritize overdue then open
    (state.issuesOverdue||[]).forEach(i=>{
      items.push({
        type: t("type_issue"),
        brand: i.brand || brandNameById(i.brandId) || "â€”",
        desc: i.title || i.note || i.description || (i.id ? `Ø±Ù‚Ù…: ${i.id}` : "â€”"),
        status: pill("warn","Ù…ØªØ£Ø®Ø±"),
        age: ageLabel(i.createdAt || i.date || i.openedAt)
      });
    });

    (state.issuesOpen||[]).slice(0,20).forEach(i=>{
      // avoid duplicating overdue items if already included
      if(String(i.status||"").includes("Ù…ØªØ£Ø®Ø±")) return;
      items.push({
        type: t("type_issue"),
        brand: i.brand || brandNameById(i.brandId) || "â€”",
        desc: i.title || i.note || i.description || (i.id ? `Ø±Ù‚Ù…: ${i.id}` : "â€”"),
        status: pill("danger","Ù…ÙØªÙˆØ­"),
        age: ageLabel(i.createdAt || i.date || i.openedAt)
      });
    });

    // Cleaning: failures first
    state.cleaning.filter(r=>r.done!=="ØªÙ…").forEach(r=>{
      items.push({
        type: t("type_cleaning"),
        brand: r.brand || "â€”",
        desc: `${r.task} â€” ${r.slot} â€” ${r.by || "â€”"}`,
        status: r.done==="Ø¬Ø²Ø¦ÙŠ" ? pill("warn","Ø¬Ø²Ø¦ÙŠ") : pill("danger","Ù„Ù… ÙŠØªÙ…"),
        age: ageLabel(r.createdAt)
      });
    });

    // Tasks: if tasks exist, show not done today
    (state.tasksToday||[]).filter(t=>{
      const st = String(t.status||"").toLowerCase();
      return !["Ù…Ù†Ø¬Ø²","done","ØªÙ…"].includes(st);
    }).forEach(t=>{
      items.push({
        type: t("type_task"),
        brand: t.brand || brandNameById(t.brandId) || "â€”",
        desc: t.title || t.task || t.description || "Ù…Ù‡Ù…Ø©",
        status: pill("warn","ØºÙŠØ± Ù…Ù†Ø¬Ø²"),
        age: ageLabel(t.createdAt || t.dueDate)
      });
    });

    // Sort: danger first, then warn, then others
    const score = (s)=>{
      if((s||"").includes("danger")) return 3;
      if((s||"").includes("warn")) return 2;
      return 1;
    };
    items.sort((a,b)=> score(b.status)-score(a.status));

    return items.slice(0,5);
  }

  function renderTop(state){
    const tbody = document.getElementById("topTbody");
    const list = topItems(state);

    tbody.innerHTML = list.map(x=>`
      <tr>
        <td>${x.type}</td>
        <td>${x.brand}</td>
        <td>${x.desc}</td>
        <td>${x.status}</td>
        <td class="muted">${x.age}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="muted">${t("noData")}</td></tr>`;
  }

  function renderAll(){
    fillBrandFilter();
    const state = compute();
    renderKPIs(state);
    renderAlerts(state);
    renderTop(state);
  }

  function bindControls(){
    document.querySelectorAll("[data-range]").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        document.querySelectorAll("[data-range]").forEach(c=>c.classList.remove("active"));
        chip.classList.add("active");
        RANGE = chip.getAttribute("data-range");
        renderAll();
      });
    });

    document.getElementById("brandFilter").addEventListener("change", (e)=>{
      BRAND = e.target.value || "";
      renderAll();
    });

    document.getElementById("refreshBtn").addEventListener("click", renderAll);
  }

  (function init(){
    setActiveNav();
    bindControls();
    renderAll();
  })();
</script>
</body>
</html>
