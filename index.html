<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نَسَق – لوحة CEO</title>

  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800;900&display=swap" rel="stylesheet">

  <style>
    body{font-family:"Almarai",sans-serif}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
    .brandTitle{font-size:22px;font-weight:900;margin:0}
    .muted{color:#6b7280}
    .cardx{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:0 12px 26px rgba(0,0,0,.08);padding:16px}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:1100px){.grid4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:650px){.grid4{grid-template-columns:1fr}}
    .kpi{border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:14px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
    .kpi .label{font-weight:900}
    .kpi .num{font-size:34px;font-weight:900}
    .kpi .sub{font-size:12px;color:#6b7280}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:none;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--nasaq-primary,#b91c1c);color:#fff}
    .btn-outline{background:#fff;border:1px solid rgba(0,0,0,.14);color:#111827}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px;text-align:right;font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.12);font-weight:900;font-size:12px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot-red{background:#ef4444}
    .dot-orange{background:#f59e0b}
    .dot-green{background:#22c55e}

    /* ===== Unified Top Nav ===== */
    .nasaq-topnav{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      padding:14px; margin:14px auto;
      border-radius:18px; background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }
    .nasaq-topnav .tab{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff; color:#111827; font-weight:900;
      text-decoration:none; transition:.15s ease;
    }
    .nasaq-topnav .tab:hover{transform:translateY(-1px)}
    .nasaq-topnav .tab-active{
      background: var(--nasaq-primary, #b91c1c);
      color:#fff;
      border-color: var(--nasaq-primary, #b91c1c);
    }
  </style>
</head>

<body>
<main class="container">

  <!-- NAV الموحد -->
  <div class="nasaq-topnav" id="topnav">
    <a href="index.html" class="tab" data-page="index.html">الرئيسية</a>
    <a href="visits.html" class="tab" data-page="visits.html">الزيارات</a>
    <a href="tasks.html" class="tab" data-page="tasks.html">المهام</a>
    <a href="cleaning.html" class="tab" data-page="cleaning.html">النظافة</a>
    <a href="sop.html" class="tab" data-page="sop.html">SOP</a>
    <a href="settings.html" class="tab" data-page="settings.html">الإعدادات</a>
    <a href="plans.html" class="tab" data-page="plans.html">الخطط</a>
  </div>

  <div class="cardx">
    <div class="topbar">
      <div>
        <h1 class="brandTitle">غرفة عمليات نَسَق – لوحة CEO</h1>
        <div class="muted">تلقائيًا من بيانات <b>LocalStorage</b> (زيارات + خطط + مهام).</div>
      </div>
      <span class="pill"><span class="dot dot-green"></span> MVP محلي</span>
    </div>
  </div>

  <div class="cardx" style="margin-top:14px">
    <h2 style="margin:0 0 10px;font-weight:900">مؤشرات سريعة</h2>
    <div class="grid4">
      <div class="kpi">
        <div class="label">عدد الزيارات المسجلة</div>
        <div class="num" id="k_visits">0</div>
        <div class="sub">مصدر البيانات: visits_v1</div>
      </div>
      <div class="kpi">
        <div class="label">زيارات هذا الأسبوع</div>
        <div class="num" id="k_week">0</div>
        <div class="sub">آخر 7 أيام</div>
      </div>
      <div class="kpi">
        <div class="label">عدد الخطط المتاحة</div>
        <div class="num" id="k_plans">2</div>
        <div class="sub">مصدرها: plans.html (ثابت)</div>
      </div>
      <div class="kpi">
        <div class="label">آخر زيارة</div>
        <div class="num" style="font-size:20px" id="k_last">—</div>
        <div class="sub" id="k_last_sub">لا توجد بيانات بعد</div>
      </div>
    </div>

    <div class="btnrow">
      <a class="btn btn-primary" href="visits.html" style="text-decoration:none">فتح الزيارات</a>
      <a class="btn btn-outline" href="plans.html" style="text-decoration:none">فتح الخطط</a>
      <button class="btn btn-outline" onclick="resetDemo()">تصفير البيانات (LocalStorage)</button>
    </div>
  </div>

  <div class="cardx" style="margin-top:14px">
    <h2 style="margin:0 0 10px;font-weight:900">آخر 10 زيارات</h2>
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>البراند</th>
          <th>الفرع</th>
          <th>النوع</th>
          <th>التقييم</th>
          <th>ملاحظات</th>
        </tr>
      </thead>
      <tbody id="last10">
        <tr><td colspan="6" class="muted">لا توجد زيارات مسجلة بعد.</td></tr>
      </tbody>
    </table>
  </div>

</main>

<script>
  // ===== Active tab تلقائي =====
  (function activateTab(){
    const file = (location.pathname.split("/").pop() || "index.html").toLowerCase();
    document.querySelectorAll("#topnav .tab").forEach(a=>{
      const p = (a.getAttribute("data-page")||"").toLowerCase();
      if(p === file) a.classList.add("tab-active");
    });
  })();

  // ===== Data =====
  const LS_KEY = "visits_v1";

  function loadVisits(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch(e){ return []; }
  }

  function isWithinLastDays(dateStr, days){
    const d = new Date(dateStr);
    if(String(d) === "Invalid Date") return false;
    const now = new Date();
    const ms = days * 24 * 60 * 60 * 1000;
    return (now - d) <= ms;
  }

  function refreshCEO(){
    const visits = loadVisits().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    document.getElementById("k_visits").textContent = visits.length;

    const weekCount = visits.filter(v=> isWithinLastDays(v.date, 7)).length;
    document.getElementById("k_week").textContent = weekCount;

    if(visits.length){
      const last = visits[0];
      document.getElementById("k_last").textContent = `${last.brand || "—"} / ${last.branch || "—"}`;
      document.getElementById("k_last_sub").textContent = `${last.date || ""} • ${last.type || ""} • ${last.rating || ""}`;
    }else{
      document.getElementById("k_last").textContent = "—";
      document.getElementById("k_last_sub").textContent = "لا توجد بيانات بعد";
    }

    const tbody = document.getElementById("last10");
    if(!visits.length){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">لا توجد زيارات مسجلة بعد.</td></tr>`;
      return;
    }

    const top10 = visits.slice(0,10);
    tbody.innerHTML = top10.map(v=>`
      <tr>
        <td>${v.date||""}</td>
        <td>${v.brand||""}</td>
        <td>${v.branch||""}</td>
        <td>${v.type||""}</td>
        <td>${v.rating||""}</td>
        <td>${(v.notes||"").replace(/</g,"&lt;")}</td>
      </tr>
    `).join("");
  }

  function resetDemo(){
    if(!confirm("هل أنت متأكد؟ سيتم حذف بيانات الزيارات المخزنة محليًا.")) return;
    localStorage.removeItem(LS_KEY);
    refreshCEO();
    alert("تم التصفير ✅");
  }

  refreshCEO();
</script>

</body>
</html>
