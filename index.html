<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نَسَق – لوحة CEO</title>

  <!-- NASAQ Theme -->
  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .n{font-size:26px;font-weight:900}
    .kpi .t{font-size:12px;color:rgba(234,240,255,.72)}
    .kpi .s{font-size:12px;color:rgba(234,240,255,.62)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-size:12px}
    .split{display:flex;gap:10px;flex-wrap:wrap}
    .mini{font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;padding:12px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .item b{display:block}
    .muted2{color:rgba(234,240,255,.72)}
    .pill.link{cursor:pointer}
    @media print{ .topbar,.nav,.no-print{display:none!important} }
  </style>
</head>

<body>

<!-- ===== Topbar ===== -->
<div class="topbar">
  <div class="brand">
    <div class="logo">ن</div>
    <div>
      <div style="font-weight:900;font-size:18px">غرفة عمليات نَسَق</div>
      <div class="muted">Pilot: طوبى • سدف • دبل بي — (CEO Dashboard)</div>
    </div>
  </div>
  <div class="badge">MVP محلي</div>
</div>

<!-- ===== Content ===== -->
<div class="container">
  <div class="nav">
    <a data-nav href="index.html">لوحة التحكم</a>
    <a data-nav href="visits.html">الزيارات</a>
    <a data-nav href="issues.html">CAPA &amp; الملاحظات</a>
    <a data-nav href="tasks.html">المهام</a>
    <a data-nav href="cleaning.html">النظافة اليومية</a>
    <a data-nav href="sop.html">مكتبة SOP</a>
    <a data-nav href="settings.html">الإعدادات</a>
  </div>

  <div class="grid">

    <!-- KPIs -->
    <div class="card" style="grid-column:span 12">
      <h3>لوحة CEO – مؤشرات سريعة</h3>
      <div class="muted mini">تلقائيًا من بيانات LocalStorage</div>

      <div class="grid" style="margin-top:12px">
        <div class="card" style="grid-column:span 3">
          <div class="kpi">
            <div class="n" id="kOpen">—</div>
            <div class="t">CAPA مفتوحة</div>
            <div class="s" id="kOpenSub">—</div>
          </div>
        </div>

        <div class="card" style="grid-column:span 3">
          <div class="kpi">
            <div class="n" id="kOverdue">—</div>
            <div class="t">CAPA متأخرة</div>
          </div>
        </div>

        <div class="card" style="grid-column:span 3">
          <div class="kpi">
            <div class="n" id="kHigh">—</div>
            <div class="t">حرِجة (عالي)</div>
          </div>
        </div>

        <div class="card" style="grid-column:span 3">
          <div class="kpi">
            <div class="n" id="kCleanToday">—</div>
            <div class="t">نظافة اليوم</div>
            <div class="s" id="kCleanBad">—</div>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <div class="split no-print">
            <button class="btn primary" id="goIssues">فتح CAPA</button>
            <button class="btn" id="goTasks">فتح المهام</button>
            <button class="btn ghost" id="goVisits">فتح الزيارات</button>
            <button class="btn ghost" id="exportDb">تصدير JSON</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts -->
    <div class="card" style="grid-column:span 7">
      <h3>تنبيهات عاجلة</h3>
      <div id="alertsList" class="list"></div>
    </div>

    <!-- Activity -->
    <div class="card" style="grid-column:span 5">
      <h3>آخر النشاط</h3>
      <div id="activityList" class="list"></div>
    </div>

  </div>

  <div class="footer">
    لوحة CEO — نسخة MVP محلية • الخطوة القادمة: صلاحيات + Backend
  </div>
</div>

<!-- ===== Scripts ===== -->
<script src="auth.js"></script>
<script>
  requireAuth();
</script>

<script>
/* ===== Helpers ===== */
const DB_KEY="naseq_ops_db_v1";
const todayISO=()=>new Date().toISOString().slice(0,10);
const loadDB=()=>JSON.parse(localStorage.getItem(DB_KEY)||"{}");

function setActiveNav(){
  const p=location.pathname.split("/").pop()||"index.html";
  document.querySelectorAll("[data-nav]").forEach(a=>{
    if(a.getAttribute("href")===p) a.classList.add("active");
  });
}

function renderDashboard(){
  const db=loadDB();
  const issues=db.issues||[];
  const cleaning=db.cleaningLogs||[];

  const open=issues.filter(i=>i.status!=="مغلق");
  const overdue=issues.filter(i=>i.dueDate && i.dueDate<todayISO() && i.status!=="مغلق");
  const high=issues.filter(i=>i.severity==="عالي" && i.status!=="مغلق");

  const cleanToday=cleaning.filter(c=>(c.createdAt||"").slice(0,10)===todayISO());
  const cleanBad=cleanToday.filter(c=>c.done!=="تم").length;

  document.getElementById("kOpen").textContent=open.length;
  document.getElementById("kOverdue").textContent=overdue.length;
  document.getElementById("kHigh").textContent=high.length;
  document.getElementById("kCleanToday").textContent=cleanToday.length;
  document.getElementById("kCleanBad").textContent=`غير مطابق: ${cleanBad}`;

  document.getElementById("alertsList").innerHTML =
    overdue.slice(0,5).map(i=>`
      <div class="item">
        <div>
          <b>${i.id}</b>
          <div class="muted2 mini">${i.title||""}</div>
        </div>
        <span class="pill warn link" onclick="location.href='issues.html?edit=${i.id}'">فتح</span>
      </div>
    `).join("") || `<div class="muted2 mini">لا توجد تنبيهات</div>`;

  document.getElementById("activityList").innerHTML =
    cleanToday.slice(-5).reverse().map(c=>`
      <div class="item">
        <div>
          <b>نظافة – ${c.task}</b>
          <div class="muted2 mini">${c.by||""} • ${c.done}</div>
        </div>
      </div>
    `).join("") || `<div class="muted2 mini">لا يوجد نشاط بعد</div>`;
}

(function init(){
  setActiveNav();
  renderDashboard();

  document.getElementById("goIssues").onclick=()=>location.href="issues.html";
  document.getElementById("goTasks").onclick=()=>location.href="tasks.html";
  document.getElementById("goVisits").onclick=()=>location.href="visits.html";
  document.getElementById("exportDb").onclick=()=>{
    const blob=new Blob([JSON.stringify(loadDB(),null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="naseq_ops_export.json";
    a.click();
  };
})();
</script>

</body>
</html>
