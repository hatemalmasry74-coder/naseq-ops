<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>منصة نَسَق – الزيارات</title>

  <link rel="stylesheet" href="nasaq-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    .mini{font-size:12px}
    .hl{outline:2px solid rgba(77,163,255,.6);border-radius:12px}
    .tag-link{cursor:pointer;text-decoration:underline}
    .pill.link{cursor:pointer}
    .row .input{flex:1;min-width:180px}
    @media print{
      .topbar,.nav,.no-print{display:none!important}
      body{background:#fff!important;color:#000!important}
    }
  </style>
</head>

<body>
<div class="topbar">
  <div class="brand">
    <div class="logo">ن</div>
    <div>
      <div style="font-weight:900;font-size:18px">غرفة عمليات نَسَق</div>
      <div class="muted">Pilot: طوبى • سدف • دبل بي — (عربي/RTL)</div>
    </div>
  </div>
  <div class="badge">MVP محلي</div>
</div>

<div class="container">
  <div class="nav">
    <a data-nav href="index.html">لوحة التحكم</a>
    <a data-nav href="visits.html">الزيارات</a>
    <a data-nav href="issues.html">CAPA &amp; الملاحظات</a>
    <a data-nav href="tasks.html">المهام</a>
    <a data-nav href="cleaning.html">النظافة اليومية</a>
    <a data-nav href="sop.html">مكتبة SOP</a>
    <a data-nav href="settings.html">الإعدادات</a>
  </div>

  <div class="grid">
    <!-- CREATE VISIT -->
    <div class="card" style="grid-column:span 5">
      <h3>إنشاء زيارة</h3>
      <div class="muted mini">
        أي زيارة (غير مطابقة) يمكن تحويلها مباشرة إلى CAPA.
      </div>

      <label class="small">البراند</label>
      <select id="vBrand" class="input"></select>

      <label class="small">الفرع</label>
      <select id="vBranch" class="input"></select>

      <label class="small">نوع الزيارة</label>
      <select id="vType" class="input">
        <option>تشغيلية</option>
        <option>مالية</option>
        <option>نظافة</option>
        <option>إدارية</option>
      </select>

      <label class="small">التقييم</label>
      <select id="vResult" class="input">
        <option value="مطابق">مطابق</option>
        <option value="غير مطابق">غير مطابق</option>
      </select>

      <label class="small">ملاحظات الزيارة</label>
      <textarea id="vNotes" class="input" style="min-height:90px"
        placeholder="اكتب ملخص الزيارة..."></textarea>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="addVisit">حفظ الزيارة</button>
        <button class="btn ghost" id="resetVisit" type="button">تفريغ</button>
      </div>
    </div>

    <!-- VISITS TABLE -->
    <div class="card" style="grid-column:span 7">
      <h3>سجل الزيارات</h3>

      <div class="row no-print" style="margin:10px 0">
        <select id="fType" class="input" style="max-width:220px">
          <option value="">كل الأنواع</option>
          <option>تشغيلية</option><option>مالية</option>
          <option>نظافة</option><option>إدارية</option>
        </select>
        <select id="fResult" class="input" style="max-width:220px">
          <option value="">كل النتائج</option>
          <option>مطابق</option><option>غير مطابق</option>
        </select>
        <input id="fSearch" class="input" placeholder="بحث (براند/فرع/ملاحظة/CAPA)">
        <button class="btn" onclick="window.print()">PDF</button>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>البراند</th>
            <th>الفرع</th>
            <th>النوع</th>
            <th>النتيجة</th>
            <th>CAPA</th>
            <th>ملاحظات</th>
          </tr>
        </thead>
        <tbody id="visitTbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    نموذج أولي — أي زيارة غير مطابقة يمكن متابعتها عبر CAPA.
  </div>
</div>

<script>
/* ===== DB ===== */
const DB_KEY="naseq_ops_db_v1";
const nowISO=()=>new Date().toISOString();
const load=()=>JSON.parse(localStorage.getItem(DB_KEY)||"null")||seed();
const save=db=>localStorage.setItem(DB_KEY,JSON.stringify(db));

function seed(){
  const db={
    brands:[
      {id:"tuba",name:"طوبى",branches:[{id:"main",name:"الفرع الرئيسي"}]},
      {id:"sdf",name:"سدف",branches:[{id:"main",name:"الفرع الرئيسي"}]},
      {id:"dbb",name:"دبل بي",branches:[{id:"main",name:"الفرع الرئيسي"}]}
    ],
    visits:[],
    issues:[],
    cleaningLogs:[],
    tasks:[]
  };
  save(db);return db;
}

/* ===== Helpers ===== */
const $=id=>document.getElementById(id);
const $$=sel=>Array.from(document.querySelectorAll(sel));
function setActiveNav(){
  const p=location.pathname.split("/").pop();
  $$("[data-nav]").forEach(a=>a.getAttribute("href")===p&&a.classList.add("active"));
}
function genCapa(){return "CAPA-"+Math.random().toString(16).slice(2,6).toUpperCase();}

/* ===== Init brand/branch ===== */
function initSelectors(){
  const db=load();
  $("vBrand").innerHTML=db.brands.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  $("vBrand").onchange=()=>{
    const b=db.brands.find(x=>x.id===$("vBrand").value);
    $("vBranch").innerHTML=b.branches.map(br=>`<option value="${br.id}">${br.name}</option>`).join("");
  };
  $("vBrand").dispatchEvent(new Event("change"));
}

/* ===== Render ===== */
function renderVisits(){
  const db=load();
  let rows=db.visits.slice();
  if($("fType").value) rows=rows.filter(r=>r.type===$("fType").value);
  if($("fResult").value) rows=rows.filter(r=>r.result===$("fResult").value);
  if($("fSearch").value){
    const q=$("fSearch").value.toLowerCase();
    rows=rows.filter(r=>JSON.stringify(r).toLowerCase().includes(q));
  }

  $("visitTbody").innerHTML=rows.reverse().map(r=>`
    <tr>
      <td>${new Date(r.createdAt).toLocaleString("ar-SA")}</td>
      <td>${r.brandName}</td>
      <td>${r.branchName}</td>
      <td>${r.type}</td>
      <td>
        <span class="pill ${r.result==="مطابق"?"ok":"danger"}">${r.result}</span>
      </td>
      <td>
        ${r.capaId
          ? `<span class="pill warn link" onclick="openCapa('${r.capaId}')">${r.capaId}</span>`
          : "—"}
      </td>
      <td class="muted">${r.notes||"—"}</td>
    </tr>
  `).join("") || `<tr><td colspan="7" class="muted">لا توجد زيارات.</td></tr>`;
}

/* ===== Add visit ===== */
function addVisit(){
  const db=load();
  const rec={
    id:"v_"+Math.random().toString(16).slice(2),
    brandId:$("vBrand").value,
    brandName:$("vBrand").selectedOptions[0].text,
    branchId:$("vBranch").value,
    branchName:$("vBranch").selectedOptions[0].text,
    type:$("vType").value,
    result:$("vResult").value,
    notes:$("vNotes").value,
    createdAt:nowISO(),
    capaId:null
  };

  if(rec.result==="غير مطابق"){
    rec.capaId=genCapa();
    db.issues.push({
      id:rec.capaId,
      source:"visit",
      status:"مفتوح",
      severity:"متوسط",
      title:`زيارة ${rec.type} غير مطابقة`,
      note:rec.notes,
      brandId:rec.brandId,
      branchId:rec.branchId,
      createdAt:nowISO()
    });
  }

  db.visits.push(rec);
  save(db);
  alert(rec.capaId ? `تم الحفظ وإنشاء CAPA ${rec.capaId}` : "تم حفظ الزيارة");
  resetVisit();
  renderVisits();
}

function resetVisit(){
  $("vType").value="تشغيلية";
  $("vResult").value="مطابق";
  $("vNotes").value="";
}

function openCapa(id){
  location.href=`issues.html?edit=${id}`;
}

/* ===== Init ===== */
(function(){
  setActiveNav();
  initSelectors();
  renderVisits();
  $("addVisit").onclick=addVisit;
  $("resetVisit").onclick=resetVisit;
  ["fType","fResult","fSearch"].forEach(id=>$(id).onchange=$(id).oninput=renderVisits);
})();
</script>
</body>
</html>
